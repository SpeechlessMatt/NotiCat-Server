package main

// THIS FILE IS GENERATED BY Gemini 3 & Czy_4201b
//
// Author 1: Gemini 3 Flash (It is really strong)
// Author 2: Czy_4201b <speechlessmatt@qq.com>
// Created: 2026-02-03
//
// "Code is a craft; automation is the soul."
// è®©ä»£ç è‡ªåŠ¨ç”Ÿé•¿ï¼Œè®©çµæ„Ÿä¸“æ³¨æ ¸å¿ƒã€‚
// --Gemini

import (
	"encoding/json"
	"flag"
	"fmt"
	"os"
	"path/filepath"
	"text/template"
	"time"
)

// ClientDetail å¯¹åº”å•ä¸ª Client çš„é…ç½®
type ClientDetail struct {
	Client      string           `json:"client"`
	Name        string           `json:"name"`
	URL         string           `json:"url"`
	Description string           `json:"description"`
	Credentials []string         `json:"credentials"`
	Extra       []map[string]any `json:"extra"`
}

// InfoConfig å¯¹åº” info.json çš„å®Œæ•´åŒ…è£…ç»“æ„
type InfoConfig struct {
	Name           string         `json:"name"`
	Version        string         `json:"version"`
	BuildTime      string         `json:"build_time"`
	Owner          string         `json:"owner"`
	Description    string         `json:"description"`
	SupportClients []ClientDetail `json:"support_clients"`
}

const (
	clientsSource = "cmd/gen/clients.json"
	infoTarget    = "internal/meta/data/info.json"
	goTarget      = "internal/bridge/clients.go"
	readmeSource  = "cmd/gen/README.md"
	readmeTarget  = "internal/meta/data/README.md"
)

const goTemplate = `// Code generated by cmd/gen; DO NOT EDIT.
//go:generate go run ../../cmd/gen/main.go
package bridge

type Client string

// register Clients
const (
{{- range .SupportClients}}
	Client{{.Name}} Client = "{{.Client}}"
{{- end}}
)
// const register

var SupportedClients = map[Client]bool{
{{- range .SupportClients}}
	Client{{.Name}}: true,
{{- end}}
}
// map register
// end register
`

// updateInfoJSON è´Ÿè´£å°†é…ç½®å†™å› info.json
func updateInfoJSON(targetPath string, config InfoConfig) {
	// æ¯æ¬¡ç”Ÿæˆæ—¶è‡ªåŠ¨æ›´æ–° BuildTime ä¸ºå½“å‰æ—¶é—´
	config.BuildTime = time.Now().Format(time.RFC3339)

	// å°†ç»“æ„ä½“åºåˆ—åŒ–ä¸ºå¸¦ç¼©è¿›çš„ JSON
	newJSON, err := json.MarshalIndent(config, "", "    ")
	if err != nil {
		fmt.Printf("âŒ åºåˆ—åŒ– info.json å¤±è´¥: %v\n", err)
		return
	}

	err = os.WriteFile(targetPath, newJSON, 0o644)
	if err != nil {
		fmt.Printf("âŒ å†™å…¥ info.json å¤±è´¥: %v\n", err)
		return
	}
	fmt.Println("âœ… å·²åŒæ­¥è‡³ internal/meta/data/info.json")
}

func copyFile(src, dst string) {
    data, err := os.ReadFile(src)
    if err != nil {
        fmt.Printf("âš ï¸  è·³è¿‡ README: æ‰¾ä¸åˆ°æºæ–‡ä»¶ %s\n", src)
        return
    }

    err = os.WriteFile(dst, data, 0644)
    if err != nil {
        fmt.Printf("âŒ å¤åˆ¶ README å¤±è´¥: %v\n", err)
        return
    }
    fmt.Println("âœ… README.md å·²åŒæ­¥è‡³ internal/meta/data/")
}

func main() {
	var rootDir string
	flag.StringVar(&rootDir, "root", ".", "Project root directory")
	flag.Parse()

	originJSON := filepath.Join(rootDir, clientsSource)
	originReadme := filepath.Join(rootDir, readmeSource)

	goFile := filepath.Join(rootDir, goTarget)
	infoFile := filepath.Join(rootDir, infoTarget)
	readmeFile := filepath.Join(rootDir, readmeTarget)

	// 1. è¯»å–æ¯æœ¬ JSON
	data, err := os.ReadFile(originJSON)
	if err != nil {
		fmt.Printf("âŒ é”™è¯¯: æ‰¾ä¸åˆ°æ¯æœ¬æ–‡ä»¶ %s\n", originJSON)
		return
	}

	// 2. è§£æ JSON åˆ°ç»“æ„ä½“
	// æ³¨æ„ï¼šä½ çš„æ¯æœ¬ clients.json å»ºè®®ç›´æ¥å†™æˆæ»¡è¶³ InfoConfig ç»“æ„çš„ JSON
	var config InfoConfig
	if err := json.Unmarshal(data, &config); err != nil {
		fmt.Printf("âŒ JSON è§£æå¤±è´¥: %v\n", err)
		return
	}

	// 3. ç”Ÿæˆ Go æ–‡ä»¶
	tmpl, err := template.New("gen").Parse(goTemplate)
	if err != nil {
		fmt.Printf("âŒ æ¨¡æ¿è§£æå¤±è´¥: %v\n", err)
		return
	}

	f, err := os.Create(goFile)
	if err != nil {
		fmt.Printf("âŒ æ— æ³•åˆ›å»º Go æ–‡ä»¶: %v\n", err)
		return
	}
	defer f.Close()

	if err := tmpl.Execute(f, config); err != nil {
		fmt.Printf("âŒ æ¸²æŸ“æ¨¡æ¿å¤±è´¥: %v\n", err)
		return
	}

	// 4. åŒæ­¥æ›´æ–° info.json
	updateInfoJSON(infoFile, config)
	copyFile(originReadme, readmeFile)

	fmt.Printf("\nâœ¨ æ­å–œï¼å·²æ ¹æ® %d ä¸ªå®¢æˆ·ç«¯ä¿¡æ¯å®Œæˆå…¨é“¾è·¯åŒæ­¥ã€‚\n", len(config.SupportClients))
	fmt.Printf("ğŸ“ ä»£ç ä½ç½®: %s\n", goFile)
	fmt.Printf("ğŸ“ é…ç½®ä½ç½®: %s\n", infoFile)
	fmt.Printf("ğŸ“ é…ç½®ä½ç½®: %s\n", readmeFile)
}
